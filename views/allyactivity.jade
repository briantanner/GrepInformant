extends layout

block content
  h1= title
  div.ally
    select.allySelect(name='ally[]')
      option(value='') Select Alliance
      each o in alliances
        option(value=o.id) #{o.name} (#{o.rank})
  span.clear
  a(href="#", style="width: 100px;font-size: 10px;display:block; margin-bottom: 1em;", onclick='$("table.players").toggle(); $("textarea.bbcode").toggle(); return false;') bbcode
  if players
    table.players
      tr
        td 
          strong Rank
        td 
          strong Name
        td 
          strong Towns
        td 
          strong Towns Delta
        td 
          strong Att BP
        td 
          strong Def BP
        td 
          strong Total BP
      each o, i in players
        tr
          td #{i+1}
          td #{o.name}
          td #{o.towns}
          td #{o.towns_delta}
          td #{o.abp}
          td #{o.dbp}
          td 
            strong #{o.allbp}
    textarea.bbcode(style='width:600px;height:200px;white-space:pre-wrap;display:none;')
      | [table][**]Rank[||]Name[||]Towns[||]Towns Delta[||]Att BP[||]Def BP[||]Total BP[/**]&#13;&#10;
      each o, i in players
        [*]#{i+1}[|]#{o.name}[|]#{o.towns}[|]#{o.towns_delta}[|]#{o.abp}[|][b]#{o.allbp}[/b][/*]&#13;&#10;
      | [/table]

block scripts
  script(type='text/javascript').
    (function (UI) {
      $(document).ready(function() {
        UI.loadSelector($('select'));
        $('.allySelect').on('change', function () {
          var id = $(this).val();
          top.location.href = '/' + server + '/allianceActivity/' + id;
        });
      });
    })(new UI());

    var ctrlDown = false,
        ctrlKeys = [17,91,93],
        cKey = 67

    $('textarea')
    .mouseup(function(e){
        // fixes safari/chrome problem
        e.preventDefault();
    })
    .focus(function(e){
        $(this).select();
    })
    .click(function(e){
        $(this).select();
    })
    .keydown(function (e) {
      if (ctrlKeys.indexOf(e.keyCode) !== -1)
        ctrlDown = true;
      
      if (!ctrlDown) {
        console.log('!ctrlDown')
        e.preventDefault();
        return false;
      }

      if (e.keyCode !== cKey) {
        console.log('!cKey')
        e.preventDefault();
        return false;
      }

    })
    .keyup(function (e) {
      if (ctrlKeys.indexOf(e.keyCode) !== -1)
        ctrlDown = false;
      // e.preventDefault();
    });
